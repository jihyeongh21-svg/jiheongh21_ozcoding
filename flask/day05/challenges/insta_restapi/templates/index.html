<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>통합 관리 시스템 (No Style)</title>
    </head>
<body>
    <h1>User & Post Manager</h1>

    <div>
        <h3>새 사용자 등록</h3>
        <input type="text" id="newUserName" placeholder="사용자 이름">
        <button onclick="createUser()">사용자 추가</button>
    </div>

    <hr> <h3>사용자 및 게시글 목록</h3>
    <div id="container">
        loading...
    </div>

    <script>
        // ==========================================
        // 1. 화면 그리기 (데이터 불러오기) 함수
        // ==========================================
        async function loadAll() {
            // (1) 백엔드 API(/users)에 GET 요청을 보냅니다.
            const response = await fetch('/users');
            
            // (2) 응답받은 데이터를 JSON 형식(객체)으로 변환합니다.
            const data = await response.json();
            
            // (3) HTML의 container 요소를 찾아 변수에 저장합니다.
            const container = document.getElementById('container');
            
            // (4) 기존에 있던 내용을 싹 지웁니다. (새로 그리기 위해)
            container.innerHTML = '';

            // (5) 받아온 사용자 목록(data.users)을 하나씩 반복(forEach)합니다.
            data.users.forEach(user => {
                
                // --- [A] 게시글 목록 HTML 만들기 ---
                // user.posts 배열을 돌면서 <li> 태그 문자열로 만듭니다.
                let postsHtml = user.posts.map(post => {
                    return `
                        <li>
                            <strong>${post.title}</strong> 
                            
                            (Likes: ${post.likes})
                            
                            <button onclick="likePost('${user.username}', '${post.title}')">
                                좋아요 +1
                            </button>
                        </li>
                    `;
                }).join(''); // 배열을 하나의 문자열로 합칩니다.

                // 게시글이 하나도 없으면 안내 문구를 넣습니다.
                if (postsHtml === '') {
                    postsHtml = '<li>작성된 게시글이 없습니다.</li>';
                }

                // --- [B] 사용자 카드(User Div) 만들기 ---
                // 새로운 div 태그를 생성합니다.
                const userDiv = document.createElement('div');
                
                // div 안에 들어갈 HTML을 작성합니다. (사용자 이름, 삭제 버튼, 게시글 목록, 글쓰기 폼)
                userDiv.innerHTML = `
                    <div style="border: 1px solid black; margin: 10px; padding: 10px;">
                        <h2>${user.username}</h2>
                        
                        <button onclick="deleteUser('${user.username}')">사용자 삭제</button>
                        
                        <hr>
                        
                        <ul>${postsHtml}</ul>

                        <div>
                            <input type="text" id="post-title-${user.username}" placeholder="새 게시글 제목">
                            
                            <button onclick="addPost('${user.username}')">게시글 등록</button>
                        </div>
                    </div>
                `;

                // 완성된 사용자 div를 메인 container에 추가합니다.
                container.appendChild(userDiv);
            });
        }

        // ==========================================
        // 2. 사용자 생성 함수 (POST)
        // ==========================================
        async function createUser() {
            // (1) 입력창(input)에서 값을 가져옵니다.
            const inputField = document.getElementById('newUserName');
            const name = inputField.value;

            // (2) 값이 비어있으면 알림을 띄우고 함수를 종료합니다.
            if (!name) {
                alert('이름을 입력하세요');
                return;
            }

            // (3) 서버로 데이터를 보냅니다.
            await fetch('/users', {
                method: 'POST', // 데이터 생성은 POST
                headers: {
                    'Content-Type': 'application/json' // "나 JSON 보낸다"라고 알려줌
                },
                body: JSON.stringify({ username: name }) // 자바스크립트 객체를 JSON 문자열로 변환
            });

            // (4) 입력창을 비워줍니다.
            inputField.value = '';

            // (5) 목록을 최신 상태로 다시 불러옵니다.
            loadAll();
        }

        // ==========================================
        // 3. 게시글 추가 함수 (POST)
        // ==========================================
        async function addPost(username) {
            // (1) 해당 사용자의 input ID를 찾습니다. (예: post-title-leo)
            const inputId = `post-title-${username}`;
            const inputField = document.getElementById(inputId);
            const title = inputField.value;
            
            // (2) 제목이 없으면 경고
            if (!title) {
                alert('게시글 제목을 입력하세요');
                return;
            }

            // (3) 서버의 특정 사용자 게시글 추가 주소로 요청을 보냅니다.
            await fetch(`/users/post/${username}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: title })
            });

            // (4) 목록 새로고침
            loadAll(); 
        }

        // ==========================================
        // 4. 좋아요 증가 함수 (PUT)
        // ==========================================
        async function likePost(username, title) {
            // (1) 서버의 좋아요 주소로 PUT 요청을 보냅니다. (데이터 수정은 PUT)
            // URL에 사용자 이름과 제목이 포함되어 있습니다.
            await fetch(`/users/post/like/${username}/${title}`, {
                method: 'PUT'
            });

            // (2) 숫자가 바뀌었으니 목록을 다시 불러옵니다.
            loadAll();
        }

        // ==========================================
        // 5. 사용자 삭제 함수 (DELETE)
        // ==========================================
        async function deleteUser(username) {
            // (1) 진짜 삭제할 건지 물어봅니다. (확인=true, 취소=false)
            const isConfirmed = confirm(`정말 ${username}님을 삭제하시겠습니까?`);

            if (isConfirmed) {
                // (2) 확인을 눌렀다면 DELETE 요청을 보냅니다.
                await fetch(`/users/${username}`, {
                    method: 'DELETE'
                });

                // (3) 목록 새로고침
                loadAll();
            }
        }

        // ==========================================
        // 6. 페이지가 처음 열릴 때 실행
        // ==========================================
        loadAll(); 

    </script>
</body>
</html>