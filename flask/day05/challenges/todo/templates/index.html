<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JWT Todo App</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .hidden { display: none; }
        #todo-section { margin-top: 20px; padding-top: 20px; border-top: 2px solid #ccc; }
        .todo-item { margin-bottom: 10px; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; }
        .completed { text-decoration: line-through; color: gray; }
        button { cursor: pointer; margin-left: 5px; }
        .auth-box { border: 1px solid #ddd; padding: 15px; width: 300px; background: #fafafa; }
    </style>
</head>
<body>
    <h1>ğŸ“ My Todo List</h1>

    <div id="login-section" class="auth-box">
        <h3>ë¡œê·¸ì¸</h3>
        <input type="text" id="login-username" placeholder="ì•„ì´ë””"><br><br>
        <input type="password" id="login-password" placeholder="ë¹„ë°€ë²ˆí˜¸"><br><br>
        <button onclick="login()">ë¡œê·¸ì¸</button>
        <button onclick="toggleAuth('register')">íšŒì›ê°€ì… í•˜ëŸ¬ê°€ê¸°</button>
        <p id="login-msg" style="color: red; font-size: 14px;"></p>
    </div>

    <div id="register-section" class="auth-box hidden">
        <h3>ìƒˆ ìœ ì € ì¶”ê°€ (íšŒì›ê°€ì…)</h3>
        <input type="text" id="reg-username" placeholder="ìƒˆ ì•„ì´ë””"><br><br>
        <input type="password" id="reg-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"><br><br>
        <button onclick="registerUser()">ê°€ì…í•˜ê¸°</button>
        <button onclick="toggleAuth('login')">ëŒì•„ê°€ê¸°</button>
        <p id="reg-msg" style="color: red; font-size: 14px;"></p>
    </div>


    <div id="todo-section" class="hidden">
        <h3>ë‚˜ì˜ í•  ì¼</h3>
        
        <div>
            <input type="text" id="new-todo-title" placeholder="ìƒˆë¡œìš´ í•  ì¼ ì…ë ¥">
            <button onclick="createTodo()">ì¶”ê°€</button>
            <button onclick="logout()" style="float: right; background: #ff4d4d; color: white; border: none; padding: 5px 10px;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <br>
        <div id="todo-list"></div>
    </div>

    <script>
        let authToken = "";

        // ë°±ì—”ë“œ API ì£¼ì†Œ (ì´ì „ì— ì‘ì„±í•˜ì‹  ë°±ì—”ë“œ ë¼ìš°íŠ¸ ê¸°ì¤€)
        const LOGIN_API_URL = "/login/";
        const REGISTER_API_URL = "/login/register"; // íšŒì›ê°€ì… ì£¼ì†Œ
        const TODO_API_URL = "/todo/";

        // -----------------------------------------
        // UI ì „í™˜ í•¨ìˆ˜ (ë¡œê·¸ì¸ì°½ <-> íšŒì›ê°€ì…ì°½)
        // -----------------------------------------
        function toggleAuth(type) {
            document.getElementById("login-msg").innerText = "";
            document.getElementById("reg-msg").innerText = "";

            if (type === 'register') {
                document.getElementById("login-section").classList.add("hidden");
                document.getElementById("register-section").classList.remove("hidden");
            } else {
                document.getElementById("register-section").classList.add("hidden");
                document.getElementById("login-section").classList.remove("hidden");
            }
        }

        // -----------------------------------------
        // íšŒì›ê°€ì… (POST /login/register)
        // -----------------------------------------
        async function registerUser() {
            const usernameVal = document.getElementById("reg-username").value;
            const passwordVal = document.getElementById("reg-password").value;

            if (!usernameVal || !passwordVal) {
                return alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
            }

            const response = await fetch(REGISTER_API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username: usernameVal, password: passwordVal })
            });

            const data = await response.json();

            if (response.ok) {
                alert("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                document.getElementById("reg-username").value = "";
                document.getElementById("reg-password").value = "";
                toggleAuth('login'); // ë‹¤ì‹œ ë¡œê·¸ì¸ ì°½ìœ¼ë¡œ ì´ë™
            } else {
                document.getElementById("reg-msg").innerText = data.msg || "íšŒì›ê°€ì… ì‹¤íŒ¨";
            }
        }

        // -----------------------------------------
        // ë¡œê·¸ì¸ (POST /login/)
        // -----------------------------------------
        async function login() {
            const usernameVal = document.getElementById("login-username").value;
            const passwordVal = document.getElementById("login-password").value;

            const response = await fetch(LOGIN_API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username: usernameVal, password: passwordVal })
            });

            const data = await response.json();

            if (response.ok) {
                authToken = data.access_token;
                document.getElementById("login-section").classList.add("hidden");
                document.getElementById("todo-section").classList.remove("hidden");
                loadTodos(); // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ í•  ì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            } else {
                document.getElementById("login-msg").innerText = data.msg || "ë¡œê·¸ì¸ ì‹¤íŒ¨";
            }
        }

        // -----------------------------------------
        // ë¡œê·¸ì•„ì›ƒ
        // -----------------------------------------
        function logout() {
            authToken = ""; 
            document.getElementById("login-section").classList.remove("hidden");
            document.getElementById("todo-section").classList.add("hidden");
            document.getElementById("login-username").value = "";
            document.getElementById("login-password").value = "";
            document.getElementById("todo-list").innerHTML = ""; // í™”ë©´ ì´ˆê¸°í™”
        }

        // ==========================================
        // ì•„ë˜ë¶€í„°ëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•œ Todo ê´€ë ¨ í•¨ìˆ˜ë“¤
        // ==========================================
        
        // -----------------------------------------
        // Todo ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ìˆ˜ì •ë¨)
        // -----------------------------------------
        async function loadTodos() {
            const response = await fetch(TODO_API_URL, {
                method: "GET",
                headers: { "Authorization": "Bearer " + authToken }
            });

            // ğŸ‘‰ [ìˆ˜ì • í•µì‹¬] ì§„ì§œë¡œ í† í°ì— ë¬¸ì œê°€ ìˆëŠ” 401(Unauthorized) ì—ëŸ¬ì¼ ë•Œë§Œ ì«“ì•„ëƒ…ë‹ˆë‹¤.
            if (response.status === 401) {
                alert("ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                logout();
                return;
            }

            if (!response.ok) {
                console.log("ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            const todos = await response.json();
            const listDiv = document.getElementById("todo-list");
            listDiv.innerHTML = "";

            // ğŸ‘‰ [ìƒˆë¡œìš´ ê¸°ëŠ¥] í•  ì¼ì´ 0ê°œë©´ ì˜ˆìœ ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
            if (todos.length === 0) {
                listDiv.innerHTML = "<p style='color: #888; font-size: 14px;'>ğŸ‰ ì•„ì§ ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤! ìƒˆë¡œìš´ í•  ì¼ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”.</p>";
                return;
            }

            todos.forEach(todo => {
                const todoDiv = document.createElement("div");
                todoDiv.className = "todo-item";
                const titleClass = todo.completed ? "completed" : "";
                
                todoDiv.innerHTML = `
                    <span class="${titleClass}"><strong>${todo.title}</strong></span>
                    <div style="margin-top: 5px;">
                        <button onclick="toggleTodo(${todo.id}, ${!todo.completed})">
                            ${todo.completed ? "ì·¨ì†Œ" : "ì™„ë£Œ"}
                        </button>
                        <button onclick="deleteTodo(${todo.id})" style="color: red;">ì‚­ì œ</button>
                    </div>
                `;
                listDiv.appendChild(todoDiv);
            });
        }

        async function createTodo() {
            const titleVal = document.getElementById("new-todo-title").value;
            if (!titleVal) return alert("í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”!");

            await fetch(TODO_API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + authToken 
                },
                body: JSON.stringify({ title: titleVal })
            });
            document.getElementById("new-todo-title").value = ""; 
            loadTodos(); 
        }

        async function toggleTodo(todoId, isCompleted) {
            await fetch(TODO_API_URL + todoId, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + authToken 
                },
                body: JSON.stringify({ completed: isCompleted })
            });
            loadTodos(); 
        }

        async function deleteTodo(todoId) {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await fetch(TODO_API_URL + todoId, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + authToken }
            });
            loadTodos(); 
        }
    </script>
</body>
</html>